name: Create Release

on:
  push:
    tags:
      - 'V*'  # Triggers on tags that start with 'V' (e.g., V1.0.0, V2.1.3)

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to create releases and upload assets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Get tag name
        id: tag
        run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
      - name: Check if BlueMarble.user.js exists
        run: |
          if [ ! -f "dist/BlueMarble.user.js" ]; then
            echo "âŒ Error: dist/BlueMarble.user.js not found!"
            exit 1
          fi
          echo "âœ… BlueMarble.user.js found"
          
      - name: Get file size
        id: filesize
        run: |
          SIZE=$(du -h "dist/BlueMarble.user.js" | cut -f1)
          echo "FILE_SIZE=$SIZE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ File size: $SIZE"
          
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸŽ‰ Blue Marble Release ${{ steps.tag.outputs.TAG_NAME }}
          
          ### ðŸ“¦ What's included:
          - **BlueMarble.user.js** - Main userscript file (${{ steps.filesize.outputs.FILE_SIZE }})
          
          ### ðŸš€ Installation:
          1. Make sure you have a userscript manager installed (Tampermonkey, Greasemonkey, etc.)
          2. Click on the **BlueMarble.user.js** file below to download
          3. Your userscript manager should automatically prompt you to install it
          
          ### ðŸ”§ Features:
          - Template overlay system for pixel art collaboration
          - Advanced pixel counting and progress tracking
          - Enhanced crosshair mode for better visibility
          - Color filtering and management tools
          - Mini progress tracker
          - Mobile-friendly interface
          
          ### ðŸ“ Notes:
          - This is an automated release created from tag ${{ steps.tag.outputs.TAG_NAME }}
          - For support and documentation, visit the [project repository](https://github.com/${{ github.repository }})
          
          ---
          *Generated automatically by GitHub Actions*
          EOF
          
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.TAG_NAME }}
          release_name: "Blue Marble ${{ steps.tag.outputs.TAG_NAME }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          
      - name: Upload BlueMarble.user.js
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/BlueMarble.user.js
          asset_name: BlueMarble.user.js
          asset_content_type: application/javascript
          

        
      - name: Release Summary
        run: |
          echo "ðŸŽ‰ Release created successfully!"
          echo "ðŸ“¦ Tag: ${{ steps.tag.outputs.TAG_NAME }}"
          echo "ðŸ”— Release URL: ${{ steps.create_release.outputs.html_url }}"
          echo "ðŸ“ File uploaded:"
          echo "  - BlueMarble.user.js (${{ steps.filesize.outputs.FILE_SIZE }})"
